# Q1 第一题（粉丝投票反推）模型与代码说明（中文）

> 本文档用于论文组内阅读与写作对齐，说明 Q1 第一题的**建模思想、公式、参数来源、约束条件、求解流程、输出文件字段含义**，并回答题目要求：
> 
> 1. 反推出每周每位选手的粉丝投票占比；
> 2. 该投票是否能复现每周淘汰结果，并给出一致性度量；
> 3. 反推投票的确定性（不确定性区间）有多大，是否随选手/周次变化，并给出度量。

---

## 0. 为什么这是"逆优化/重构"而不是拟合回归

题目明确：粉丝投票未知且不可获得，因此没有可用于监督学习的真实标签（ground truth）。  
我们已知的是：每周评委评分（或名次）和真实淘汰结果。

因此本题属于典型 **不适定逆问题（ill-posed inverse problem）**：  
存在许多不同的投票分布都可能解释同样的淘汰结果，我们需要在"所有可解释历史淘汰事实"的投票分布中，选出一条在时间上最平滑、最合理的解轨迹。这一过程属于 **逆向优化（inverse optimization）/重构（reconstruction）**。

---

## 1. 符号与变量定义（与代码/输出一致）

以某一赛季的第 $t$ 周为单位。

### 1.1 集合与人数

- $A_t$：第 $t$ 周仍在场（active）的选手集合
- $N_t = |A_t|$：第 $t$ 周仍在场人数
- $E_t \subset A_t$：第 $t$ 周被淘汰的选手集合（由历史事实给出）
- $S_t = A_t \setminus E_t$：第 $t$ 周晋级（safe）集合

### 1.2 已知量（来自数据）

- $J_t \in \mathbb{R}^{N_t}$：第 $t$ 周评委评分占比向量（已知）  
    其中 $j_{i,t}$ 为选手 $i$ 在该周的评委评分占比： $$j_{i,t}=\frac{\text{total_judge}_{i,t}}{\sum_{u\in A_t}\text{total_judge}_{u,t}}$$
- $R^J_{i,t}$：评委名次（rank 赛季使用），由 $\text{total_judge}$ 从高到低排序得到（名次越小越好）。

### 1.3 未知量（模型要反推的核心）

- $V_t \in \mathbb{R}^{N_t}$：第 $t$ 周粉丝投票占比向量（未知）  
    $$V_t=(v_{i,t})_{i\in A_t}$$

### 1.4 松弛变量（用于处理极少数无严格可行解的周）

- $\xi_{k,s,t}\ge 0$：用于放松淘汰一致性不等式的松弛变量（后续解释其含义）

---

## 2. 约束条件（可行域 $\Omega_t$）

我们将"历史淘汰事实"转化为对 $V_t$ 的硬性约束。

### 2.1 投票合法性：单纯形约束（Simplex）

粉丝投票必须是概率分布：

$$\sum_{i\in A_t} v_{i,t}=1,\qquad v_{i,t}\ge 0\ \ \forall i\in A_t$$

**直观解释：** 所有人票数占比加起来必须是 100%，且不可能出现负票。

---

### 2.2 淘汰一致性约束：由赛制规则导出

> 关键思想：  
> 若 $k\in E_t$ 被淘汰，而 $s\in S_t$ 晋级，则必须满足"晋级者的综合表现不劣于淘汰者"。  
> 在百分比制中综合表现来自评委占比与投票占比加权；在排名制中综合表现来自评委名次与投票名次（离散）之和，因此需要连续松弛。

---

#### 2.2.1 百分比制（percent）

题目给定：评委与粉丝权重相同，因此 $$\omega=0.5$$

综合分（用于解释）可写为： $$S_{i,t}=\omega v_{i,t}+(1-\omega)j_{i,t}$$ 当 $\omega=0.5$ 时： $$S_{i,t}=0.5,v_{i,t}+0.5,j_{i,t}$$

淘汰一致性要求： $$S_{s,t}\ge S_{k,t},\quad \forall k\in E_t,\ \forall s\in S_t$$ 代入并化简得到线性不等式： $$v_{s,t}-v_{k,t}\ge j_{k,t}-j_{s,t},\quad \forall k\in E_t,\ \forall s\in S_t$$

---

#### 2.2.2 排名制（rank）——连续松弛

排名制的原始规则是"评委名次 + 粉丝名次"之和决定淘汰，但粉丝名次是离散秩函数，不适合直接优化，因此采用连续松弛：

$$v_{s,t}-v_{k,t}\ge \delta_t\big(R^J_{s,t}-R^J_{k,t}\big), \quad \forall k\in E_t,\ \forall s\in S_t$$

其中 $\delta_t$ 为尺度参数，完全由当周人数计算： $$\delta_t=\frac{1}{N_t}$$

**直观解释：**

- 若评委更认可晋级者 $s$，则 $R^J_{s,t}-R^J_{k,t}<0$，右侧为负，约束宽松；
- 若评委更认可淘汰者 $k$，则右侧为正，迫使晋级者必须在投票占比上明显超过淘汰者才能"补偿"评委名次差。

---

### 2.3 松弛变量 $\xi$：为何引入、如何解释

在极少数周次，以上硬约束可能无严格可行解（例如赛制细节未完全显式建模、或出现"爆冷"淘汰）。  
为保证模型可解，并量化异常程度，引入松弛变量：

$$v_{s,t}-v_{k,t}\ge \text{RHS}_{k,s,t}-\xi_{k,s,t},\quad \xi_{k,s,t}\ge 0$$

其中：

- percent 赛季：$\text{RHS}_{k,s,t}=j_{k,t}-j_{s,t}$
- rank 赛季：$\text{RHS}_{k,s,t}=\delta_t(R^J_{s,t}-R^J_{k,t})$

**松弛的解释：**  
$\xi_{k,s,t}$ 表示为了让该周淘汰事实成立，我们需要把这条规则不等式放松多少。  
若 $\xi=0$，说明淘汰结果完全在规则逻辑内可解释；若 $\xi>0$，说明存在争议/爆冷/规则细节缺失。

---

## 3. 逆优化选点：为什么需要目标函数（"合理性"定义）

上述约束定义的可行域 $\Omega_t$ 往往不唯一，因此需要一个"选点原则"。  
我们用"惯性（Memory）+ 共鸣（Stimulus）"构建目标函数：

$$V_t^_= \arg\min_{V_t\in\Omega_t} \Big[ (1-\alpha_t)|V_t-V_{t-1}^_|_2^2 + \alpha_t|V_t-J_t|_2^2 \Big]$$

### 3.1 两个项分别是什么意思

- **惯性项** $|V_t-V_{t-1}^*|_2^2$：  
    表示粉丝偏好不会每周剧烈跳变（舆论/支持度具有连续性）。
    
- **共鸣项** $|V_t-J_t|_2^2$：  
    表示粉丝投票不会完全脱离当周表现（评委评分占比），即存在一定正相关趋势。
    

这两个项都是"弱假设"，用于在无标签的情况下排除极端解，使解更平滑、更可解释。

---

## 4. 参数来源说明（所有关键参数如何得到）

本模型严格遵循：除题目明确给定外，所有参数必须由数据或计算得到。

### 4.1 $\omega=0.5$（题目给定）

百分比制规则中评委评分与粉丝投票权重相同，因此固定 $\omega=0.5$。  
该参数不是调参结果。

### 4.2 $\delta_t=1/N_t$（rank 松弛尺度，由数据计算）

每周人数 $N_t$ 来自数据清洗后的 active 集合： $$\delta_t=\frac{1}{N_t}$$ 该参数用于把"名次差"映射到"投票占比差"的线性尺度。

### 4.3 $\alpha_t$（数据驱动权重，代码计算得到）

$\alpha_t$ 由评委分布变化强度决定：评委分布变化越大，越倾向"共鸣项"；越稳定，越倾向"惯性项"。

定义： $$d_t=|J_t-J_{t-1}|_2^2$$

设 $\text{scale}$ 为本赛季历史 $d_t>0$ 的中位数（均由计算得到），则： $$\alpha_t= \begin{cases} 0, & d_t=0\ 1, & \text{scale}=0\ \text{且}\ d_t>0\ \dfrac{d_t}{d_t+\text{scale}}, & \text{otherwise} \end{cases}$$

### 4.4 松弛总量 $\text{slack_sum}_t$（由优化求得）

每周先解： $$\min \sum_{k,s}\xi_{k,s,t}$$ 得到最小必要松弛结构 $\xi^_$。  
定义周总松弛： $$\text{slack_sum}_t=\sum_{k\in E_t}\sum_{s\in S_t}\xi^__{k,s,t}$$ 该值完全由求解得到，不是人为设定。

---

## 5. 一致性（Consistency）如何度量、如何从表中读取

题目要求：

> Does your model correctly estimate fan votes that lead to results consistent with who was eliminated each week? Provide measures of the consistency.

### 5.1 周级一致性指标（输出字段：`week_consistency_CI`）

我们使用松弛总量构造一致性指标： $$CI_t=1-\frac{\text{slack_sum}_t}{N_t}$$

- 若 $\text{slack_sum}_t=0$，则 $CI_t=1$：规则无需放松即可解释淘汰结果，一致性最高。
- 若 $\text{slack_sum}_t>0$，则 $CI_t<1$：需要放松规则才能解释淘汰结果，说明存在异常/争议周。

### 5.2 如何从输出表验证一致性

在输出文件中：

- `week_slack_sum`：$\text{slack_sum}_t$
- `week_consistency_CI`：$CI_t$

因此：

- 若某周 `week_slack_sum = 0`，则说明该周淘汰完全可解释；
- 若 `week_slack_sum > 0`，则该周为争议/爆冷周，可作为论文中的重点讨论周。

---

## 6. 确定性（Certainty / Uncertainty）如何评定

题目要求：

> How much certainty is there in the fan vote totals you produced, and is that certainty always the same for each contestant/week? Provide measures of your certainty for the estimates.

由于我们输出的是确定性优化的点估计 $V_t^*$，本身不带方差，因此不确定性通过**可行域边界探测**获得。

### 6.1 不确定性区间的基本定义

对每个选手 $i\in A_t$，求解两次 LP：

$$v^{\min}_{i,t}=\min v_{i,t},\qquad v^{\max}_{i,t}=\max v_{i,t}$$ s.t. $V_t$ 满足：

- 单纯形约束；
- 淘汰一致性约束（固定 $\xi^*$）；
- 见下文局部邻域约束。

输出字段：

- `fan_vote_min`：$v^{\min}_{i,t}$
- `fan_vote_max`：$v^{\max}_{i,t}$

### 6.2 不确定性宽度（输出字段：`uncertainty_width`）

$$U_{i,t}=v^{\max}_{i,t}-v^{\min}_{i,t}$$

因此表中的： $$\texttt{uncertainty_width} = \texttt{fan_vote_max} - \texttt{fan_vote_min}$$

解释：

- $U_{i,t}$ 越小，表示该选手该周投票被规则强约束，"更确定"；
- $U_{i,t}$ 越大，表示存在许多不同投票分布都能解释淘汰事实，"更不确定"。

### 6.3 相对确定性评分（输出字段：`certainty_score_0_1`）

为了可视化对比同一周不同选手的确定性，采用周内归一化：

$$CS_{i,t}=1-\frac{U_{i,t}}{\max_{j\in A_t}U_{j,t}}$$

该指标：

- 归一化到 $[0,1]$；
- 是相对指标，不是概率意义上的置信度；
- `CS=0` 表示该周最不确定的选手（区间宽度最大）。

---

## 7. 第三个约束：局部邻域约束（Local Neighborhood）

若只用单纯形 + 淘汰一致性，很多周会出现"区间接近 $[0,1]$"的无信息情况，因为晋级者之间缺少约束。  
为使不确定性评估更符合"围绕合理解释进行"的理念，我们在区间阶段引入局部邻域：

$$\forall i\in A_t:\quad |v_{i,t}-v^*_{i,t}|\le \Delta_t$$

等价写法： $$-\Delta_t \le v_{i,t}-v^*_{i,t} \le \Delta_t$$

其中 $v^*_{i,t}$ 为逆优化点估计（输出 `fan_vote_est`）。

**直观解释：**

- 我们在区间评估时只考虑"围绕最合理解附近的小幅波动"，而不是远离合理解释的极端投票结构。
- 该约束不改变点估计，只用于确定性区间计算。

### 7.1 $\Delta_t$ 的计算来源（全部可计算）

输出中：

- `tau_local`：$\tau_t$
- `delta_local`：$\Delta_t$

定义参考点： $$m_t=(1-\alpha_t)V_{t-1}^*+\alpha_t J_t$$ （冷启动 $t=1$ 时取 $m_1=J_1$）

定义偏离度： $$\tau_t=|V_t^*-m_t|_2^2$$

基础半径： $$\Delta^{(0)}_t=\sqrt{\frac{\tau_t}{N_t}}$$

为保证数值稳定与可行性，最终采用： $$\Delta_t=\max\left(\Delta^{(0)}_t,\ \text{viol}_{\max}+\varepsilon,\ \delta_{\text{feas}}+\varepsilon\right)$$

其中：

- $\varepsilon=\sqrt{\text{machine epsilon}}$（机器精度；用于浮点数容差）
- $\text{viol}_{\max}$ 为固定 $\xi^*$ 后不等式残差的最大正违反量： $$\text{viol}_{\max}=\max\left(0,\max_{(k,s)}\left[(\text{RHS}_{k,s,t}-\xi^*_{k,s,t})-(v^__{s,t}-v^__{k,t})\right]\right)$$
- $\delta_{\text{feas}}$ 为通过 LP 计算得到的"使局部盒子可行的最小半径"（完全由计算得出，不是调参）： $$\delta_{\text{feas}}=\min \delta \quad\text{s.t.}\quad V_t\in\Omega_t(\xi^_),\ \sum v=1,\ v\ge0,\ |v-v^_|\le \delta$$

---

## 8. 输出文件字段（表头）解释与如何回答题目问题

输出文件 `q1_fan_vote_estimates.csv` 中每一行对应：某赛季某周某选手。

### 8.1 字段含义

- `season`：赛季编号
- `week`：周次 $t$
- `method`：赛制类型（`percent` 或 `rank`）
- `contestant_id`：选手唯一 ID
- `judge_percent`：$j_{i,t}$，评委评分占比
- `fan_vote_est`：$v^*_{i,t}$，逆优化点估计（反推出的粉丝投票占比）
- `fan_vote_min`：$v^{\min}_{i,t}$，区间下界
- `fan_vote_max`：$v^{\max}_{i,t}$，区间上界
- `uncertainty_width`：$U_{i,t}=v^{\max}-v^{\min}$
- `certainty_score_0_1`：$CS_{i,t}$ 周内归一化相对确定性
- `week_slack_sum`：$\text{slack_sum}_t$，该周最小松弛总量
- `week_consistency_CI`：$CI_t$，该周一致性指标
- `alpha_data_driven`：$\alpha_t$，数据驱动权重
- `tau_local`：$\tau_t$，点估计偏离参考点的程度
- `delta_local`：$\Delta_t$，区间局部邻域半径（最终使用值）
- `is_eliminated_this_week`：该选手是否在该周淘汰（布尔值）

### 8.2 如何从表中回答题目 3 个问题

#### (1) 反推粉丝投票是多少？

- 直接使用 `fan_vote_est` 作为每周每位选手的投票占比估计。

#### (2) 是否与淘汰结果一致？如何度量一致性？

- 查看 `week_slack_sum` 与 `week_consistency_CI`：
    - 若 `week_slack_sum = 0`，则该周完全由规则解释（一致性最高）
    - 若 `week_slack_sum > 0`，则该周需要放松规则才能解释（争议周），一致性下降
- `week_consistency_CI` 即论文中的一致性度量。

#### (3) 投票估计有多确定？是否对选手/周次一致？

- 不确定性用 `uncertainty_width`（绝对尺度）：
    - 越小越确定
    - 越大越不确定
- 相对确定性用 `certainty_score_0_1`（同周比较）
- "是否一致"通过比较：
    - 同一选手跨周的 `uncertainty_width` 变化（纵向）
    - 同一周不同选手的 `uncertainty_width` 分散程度（横向） 即可得出：确定性通常不会在所有选手/所有周次保持一致。

---

## 9. 数据清洗/预处理代码做了什么（概述）

数据处理模块主要完成：

1. 识别所有 `weekX_judgeY_score` 列并转数值；
2. 计算每个选手每周评委总分 `total_judge`；
3. 以 `total_judge>0` 判定当周是否 active，从而构造 $A_t$；
4. 在每个赛季-周内将评委总分归一化为 `judge_percent`（即 $J_t$）；
5. 在 rank 赛季中根据 `total_judge` 降序得到 `judge_rank`（即 $R^J$）；
6. 解析 `results` 字段得到淘汰周 `elim_week`，用于构造每周淘汰集合 $E_t$。

该步骤不引入额外假设，仅保证模型输入量与索引正确。

---

## 10. 实现层面的稳定性说明（简要）

在区间计算阶段，LP 可能因浮点误差在极薄可行域下出现求解失败。 为保证输出完整性并保持建模含义不变，采用：

- 机器精度级容差 $\varepsilon=\sqrt{\text{machine epsilon}}$ 作为数值稳定余量；
- 通过 $\delta_{\text{feas}}$ 计算"最小可行邻域半径"保证区间评估可行；
- 若极少数情况下 LP 求解失败，使用局部邻域 bounds 作为保守区间。

这些处理仅用于数值稳定与输出完整性，不改变主建模思路与一致性定义。